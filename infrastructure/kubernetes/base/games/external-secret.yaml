# ExternalSecret for games-api - syncs secrets from Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: games-api-secrets
  labels:
    app.kubernetes.io/name: games-api
    app.kubernetes.io/component: games
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: azure-keyvault
  target:
    name: games-api-secrets
    creationPolicy: Owner
  data:
    # Database secrets
    - secretKey: DB_HOST
      remoteRef:
        key: db-host
    - secretKey: DB_PORT
      remoteRef:
        key: db-port
    - secretKey: DB_NAME
      remoteRef:
        key: db-name-games
    - secretKey: DB_USER
      remoteRef:
        key: db-admin-login
    - secretKey: DB_PASSWORD
      remoteRef:
        key: db-password
    - secretKey: DB_MAINTENANCE_NAME
      remoteRef:
        key: db-name-maintenance
    - secretKey: DB_SCHEMA
      remoteRef:
        key: db-schema
    - secretKey: DB_CONNECTION_TIMEOUT
      remoteRef:
        key: db-connection-timeout
    # Cache secrets
    - secretKey: CACHE_HOST
      remoteRef:
        key: cache-host
    - secretKey: CACHE_PORT
      remoteRef:
        key: cache-port
    - secretKey: CACHE_PASSWORD
      remoteRef:
        key: cache-password
    - secretKey: CACHE_SECURE
      remoteRef:
        key: cache-secure
    - secretKey: CACHE_INSTANCE_NAME
      remoteRef:
        key: cache-games-instance-name
    # Service Bus secrets (using Workload Identity - no connection string needed)
    - secretKey: AZURE_SERVICEBUS_NAMESPACE
      remoteRef:
        key: servicebus-namespace
    - secretKey: AZURE_SERVICEBUS_AUTO_PROVISION
      remoteRef:
        key: servicebus-auto-provision
    - secretKey: AZURE_SERVICEBUS_MAX_DELIVERY_COUNT
      remoteRef:
        key: servicebus-max-delivery-count
    - secretKey: AZURE_SERVICEBUS_ENABLE_DEAD_LETTERING
      remoteRef:
        key: servicebus-enable-dead-lettering
    - secretKey: AZURE_SERVICEBUS_AUTO_PURGE_ON_STARTUP
      remoteRef:
        key: servicebus-auto-purge-on-startup
    - secretKey: AZURE_SERVICEBUS_USE_CONTROL_QUEUES
      remoteRef:
        key: servicebus-use-control-queues
    - secretKey: AZURE_SERVICEBUS_TOPIC_NAME
      remoteRef:
        key: servicebus-games-topic-name
    # Elasticsearch secrets (games-api specific)
    - secretKey: ELASTICSEARCH_ENDPOINTURL
      remoteRef:
        key: elasticsearch-game-endpoint
    - secretKey: ELASTICSEARCH_APIKEY
      remoteRef:
        key: elasticsearch-game-apikey
    - secretKey: ELASTICSEARCH_PROJECTID
      remoteRef:
        key: elasticsearch-game-projectid
    - secretKey: ELASTICSEARCH_INDEXPREFIX
      remoteRef:
        key: elasticsearch-game-indexprefix
    # Grafana / OpenTelemetry secrets
    - secretKey: GRAFANA_LOGS_API_TOKEN
      remoteRef:
        key: grafana-logs-api-token
    - secretKey: GRAFANA_OTEL_PROMETHEUS_API_TOKEN
      remoteRef:
        key: grafana-otel-prometheus-api-token
    - secretKey: OTEL_RESOURCE_ATTRIBUTES
      remoteRef:
        key: grafana-otel-games-resource-attributes
    - secretKey: OTEL_EXPORTER_OTLP_ENDPOINT
      remoteRef:
        key: grafana-otel-exporter-endpoint
    - secretKey: OTEL_EXPORTER_OTLP_PROTOCOL
      remoteRef:
        key: grafana-otel-exporter-protocol
    - secretKey: OTEL_EXPORTER_OTLP_HEADERS
      remoteRef:
        key: grafana-otel-auth-header
    # Database connection pool tuning (optional)
    - secretKey: DB_MAX_POOL_SIZE
      remoteRef:
        key: db-max-pool-size
    - secretKey: DB_MIN_POOL_SIZE
      remoteRef:
        key: db-min-pool-size

