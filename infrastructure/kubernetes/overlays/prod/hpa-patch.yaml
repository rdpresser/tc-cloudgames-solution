# =============================================================================
# HPA Patches for Production - Optimized for Load
# =============================================================================
# Based on load test results (11.4 req/s, 0.14% timeouts):
# - Increased minReplicas to ensure baseline capacity
# - Increased maxReplicas for peak traffic (25+ VUs)
# - Added memory metric to prevent OOM during spikes
# - Lowered CPU threshold for faster scale-up
# =============================================================================

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: user-api
spec:
  minReplicas: 2  # Restored after AKS capacity expansion to 5 nodes
  maxReplicas: 5  # Scale up to 5 during peak (was 2)
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30  # Scale up quickly
      policies:
        - type: Percent
          value: 100  # Double pods at once if needed
          periodSeconds: 15
        - type: Pods
          value: 2  # Or add 2 pods at once
          periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5min before scale down
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60  # Scale earlier (was 70%)
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70  # Prevent memory pressure
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: games-api
spec:
  minReplicas: 2
  maxReplicas: 5
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 2
          periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: payments-api
spec:
  minReplicas: 2
  maxReplicas: 5
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 2
          periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70
