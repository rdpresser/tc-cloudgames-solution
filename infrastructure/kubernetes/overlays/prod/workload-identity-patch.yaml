# =============================================================================
# Azure Workload Identity Webhook - System Node Pool Compatibility Patch
# =============================================================================
# This patch ensures the webhook can run on the system node pool with correct labeling
# Fixes: OutOfSync issues caused by node selector mismatches
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: azure-wi-webhook-manager
  namespace: azure-workload-identity-system
spec:
  template:
    spec:
      # Ensure compatibility with system node pool (Linux nodes)
      # Only restrict to Linux OS, allow scheduler to place on any suitable node
      nodeSelector:
        kubernetes.io/os: linux
      # Allow scheduling on nodes with taints (if any)
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "system"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
