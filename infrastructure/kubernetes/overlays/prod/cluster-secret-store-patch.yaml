# =============================================================================
# ClusterSecretStore for Production Environment - Azure Workload Identity
# =============================================================================
# This configuration uses Azure Workload Identity instead of Service Principal
# credentials for secure, passwordless authentication to Azure Key Vault.
#
# Prerequisites:
# 1. External Secrets Operator installed with Workload Identity ServiceAccount
# 2. User Assigned Identity with Federated Credential created in Azure
# 3. Key Vault Secrets User role assigned to the User Assigned Identity
#
# The serviceAccountRef points to the ESO ServiceAccount that has the
# azure.workload.identity/client-id annotation.
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: azure-keyvault
  labels:
    app.kubernetes.io/part-of: cloudgames
    app.kubernetes.io/component: secrets
    environment: prod
spec:
  provider:
    azurekv:
      # Key Vault URL - Updated by Terraform or CI/CD
      # Format: https://<keyvault-name>.vault.azure.net
      vaultUrl: "https://tccloudgamesdevcr8nkv.vault.azure.net"
      # Use Workload Identity for authentication (no secrets required)
      authType: WorkloadIdentity

      # Reference to the ServiceAccount with Workload Identity annotation
      # The ServiceAccount must have: azure.workload.identity/client-id annotation
      serviceAccountRef:
        name: external-secrets-operator
        namespace: external-secrets
