# =============================================================================
# Kustomization for Production Environment - Azure AKS
# =============================================================================
# This overlay configures the application for production deployment on AKS
# - Uses Azure Container Registry for images
# - Uses Workload Identity for Key Vault access
# - Uses NGINX Ingress Controller
# - Configures production replicas and resource limits
# =============================================================================

resources:
  - ../../base
  - cluster-secret-store-patch.yaml

labels:
  - pairs:
      environment: prod

# =============================================================================
# Images - Azure Container Registry
# =============================================================================
# Update newName to match your ACR login server from Terraform output:
#   terraform output -raw acr_info | jq -r '.login_server'
# =============================================================================
images:
  - name: localhost:5000/user-api
    newName: tccloudgamesdevcr8nacr.azurecr.io/users-api
    newTag: latest
  - name: localhost:5000/games-api
    newName: tccloudgamesdevcr8nacr.azurecr.io/games-api
    newTag: latest
  - name: localhost:5000/payments-api
    newName: tccloudgamesdevcr8nacr.azurecr.io/payms-api
    newTag: latest

# =============================================================================
# Replicas - Managed by HPA
# =============================================================================
# HPA (HorizontalPodAutoscaler) manages replicas automatically:
# - minReplicas: 2 (baseline HA capacity - see hpa-patch.yaml)
# - maxReplicas: 5 (peak traffic capacity - see hpa-patch.yaml)
# - Based on CPU (60%) + Memory (70%) utilization
# Do NOT define replicas here or it will conflict with HPA

# =============================================================================
# Patches - Production Configuration
# =============================================================================
patches:
  - path: deployment-env-patch.yaml  # Resource limits, env vars, probes
  - path: ingress-patch.yaml         # NGINX ingress with SSL
  - path: hpa-patch.yaml             # Autoscaling: min=2, max=5, CPU+Memory
  - path: pdb-patch.yaml             # Pod disruption budget for HA

namespace: cloudgames

